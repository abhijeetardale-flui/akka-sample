name: Debug Vulnerability Scan (See What's Detected)

# This workflow helps debug why PRs aren't being created
# It shows exactly what vulnerabilities are found and what files need updating

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  debug-scan:
    name: Debug - Show Detected Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Create scan directory
        run: mkdir -p scan-results
      
      # ============================================
      # Scan for vulnerabilities
      # ============================================
      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'scan-results/trivy-results.json'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
      
      - name: Run Semgrep Scan
        continue-on-error: true
        run: |
          docker run --rm -v "${PWD}:/src" returntocorp/semgrep:latest \
            semgrep scan --config auto \
            --json --output /src/scan-results/semgrep-results.json \
            --severity ERROR --severity WARNING \
            /src || true
      
      # ============================================
      # Parse and display results
      # ============================================
      - name: Analyze Scan Results
        run: |
          cat > analyze.py << 'EOF'
          import json
          import os
          
          def load_json(path):
              try:
                  with open(path) as f:
                      return json.load(f)
              except:
                  return {}
          
          print("=" * 80)
          print("VULNERABILITY SCAN DEBUG REPORT")
          print("=" * 80)
          print()
          
          # Trivy results
          trivy = load_json('scan-results/trivy-results.json')
          print("ðŸ“Š TRIVY (SCA - Dependencies):")
          print("-" * 80)
          
          if 'Results' in trivy:
              total_vulns = 0
              for result in trivy['Results']:
                  target = result.get('Target', 'Unknown')
                  vulns = result.get('Vulnerabilities', [])
                  
                  if vulns:
                      print(f"\nðŸŽ¯ Target: {target}")
                      for vuln in vulns:
                          if vuln.get('Severity') in ['CRITICAL', 'HIGH']:
                              total_vulns += 1
                              pkg = vuln.get('PkgName', 'Unknown')
                              current = vuln.get('InstalledVersion', 'Unknown')
                              fixed = vuln.get('FixedVersion', 'Not available')
                              cve = vuln.get('VulnerabilityID', 'N/A')
                              severity = vuln.get('Severity', 'Unknown')
                              
                              print(f"  â€¢ [{severity}] {cve}: {pkg}")
                              print(f"    Current: {current} â†’ Fixed: {fixed}")
              
              print(f"\nâœ… Total CRITICAL/HIGH: {total_vulns}")
          else:
              print("  No vulnerabilities found")
          
          print("\n" + "=" * 80)
          
          # Semgrep results
          semgrep = load_json('scan-results/semgrep-results.json')
          print("ðŸ“Š SEMGREP (SAST - Code Issues):")
          print("-" * 80)
          
          if 'results' in semgrep:
              high_issues = [r for r in semgrep['results'] 
                           if r.get('extra', {}).get('severity') == 'ERROR']
              print(f"  High severity issues: {len(high_issues)}")
              for issue in high_issues[:5]:  # Show first 5
                  print(f"  â€¢ {issue.get('check_id', 'Unknown')}")
                  print(f"    File: {issue.get('path', 'Unknown')}:{issue.get('start', {}).get('line', '?')}")
          else:
              print("  No code issues found")
          
          print("\n" + "=" * 80)
          EOF
          
          python3 analyze.py
      
      # ============================================
      # Check what files exist
      # ============================================
      - name: List Build Files
        run: |
          echo "=" * 80
          echo "BUILD FILES IN REPOSITORY:"
          echo "=" * 80
          echo ""
          echo "ðŸ“¦ Maven (pom.xml) files:"
          find . -name "pom.xml" -type f | head -20
          echo ""
          echo "ðŸ“¦ SBT (build.sbt) files:"
          find . -name "build.sbt" -type f | head -20
          echo ""
          echo "=" * 80
      
      - name: Show Sample pom.xml Content
        continue-on-error: true
        run: |
          echo "=" * 80
          echo "SAMPLE POM.XML CONTENT (first file found):"
          echo "=" * 80
          POM=$(find . -name "pom.xml" -type f | head -1)
          if [ -n "$POM" ]; then
            echo "File: $POM"
            echo ""
            head -50 "$POM"
            echo ""
            echo "... (showing first 50 lines)"
          else
            echo "No pom.xml files found"
          fi
          echo "=" * 80
      
      - name: Check for Logback Dependencies
        run: |
          echo "=" * 80
          echo "CHECKING FOR LOGBACK DEPENDENCIES:"
          echo "=" * 80
          echo ""
          echo "In pom.xml files:"
          grep -r "logback" --include="pom.xml" . || echo "  No logback found in pom.xml"
          echo ""
          echo "In build.sbt files:"
          grep -r "logback" --include="build.sbt" . || echo "  No logback found in build.sbt"
          echo ""
          echo "=" * 80
      
      # ============================================
      # Summary
      # ============================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ” Vulnerability Scan Debug Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow helps you understand:" >> $GITHUB_STEP_SUMMARY
          echo "1. What vulnerabilities are being detected" >> $GITHUB_STEP_SUMMARY
          echo "2. What files exist in your repository" >> $GITHUB_STEP_SUMMARY
          echo "3. Why automated fixes might not be applying" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Check the workflow logs for:" >> $GITHUB_STEP_SUMMARY
          echo "- List of detected vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Files that need updating" >> $GITHUB_STEP_SUMMARY
          echo "- Current dependency versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the 'Analyze Scan Results' step" >> $GITHUB_STEP_SUMMARY
          echo "2. Check the 'List Build Files' step" >> $GITHUB_STEP_SUMMARY
          echo "3. See if dependencies match what needs fixing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If vulnerabilities are found but no files match, the automated fix workflow won't create a PR." >> $GITHUB_STEP_SUMMARY

