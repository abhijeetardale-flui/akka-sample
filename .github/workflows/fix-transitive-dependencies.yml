name: Fix Transitive Dependencies (Auto PR)

# This workflow identifies and fixes vulnerabilities in transitive dependencies
# It uses dependency management to force secure versions

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'  # Every Monday at 4 AM UTC

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-transitive-deps:
    name: Fix Transitive Dependency Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Create working directories
        run: |
          mkdir -p scan-results
          mkdir -p fixes
      
      # ============================================
      # 1. Scan for Vulnerabilities
      # ============================================
      - name: Scan with Trivy (includes transitive deps)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'scan-results/trivy-full.json'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
      
      - name: Run Maven Dependency Tree Analysis
        continue-on-error: true
        run: |
          echo "ðŸ” Analyzing Maven dependency trees..."
          
          for pom in $(find . -name "pom.xml" -type f | grep -v target); do
            dir=$(dirname "$pom")
            echo "Analyzing: $pom"
            
            cd "$dir"
            # Generate dependency tree
            mvn dependency:tree -DoutputFile=dependency-tree.txt -DoutputType=text || true
            cd - > /dev/null
          done
          
          echo "âœ… Dependency tree analysis complete"
      
      # ============================================
      # 2. Identify Transitive Dependencies
      # ============================================
      - name: Identify Transitive Dependency Vulnerabilities
        id: identify
        run: |
          cat > identify_transitive.py << 'EOF'
          import json
          import os
          import re
          
          def load_json(path):
              try:
                  with open(path) as f:
                      return json.load(f)
              except:
                  return {}
          
          print("=" * 80)
          print("TRANSITIVE DEPENDENCY VULNERABILITY ANALYSIS")
          print("=" * 80)
          
          trivy = load_json('scan-results/trivy-full.json')
          
          # Track vulnerabilities by package
          vulnerabilities = {}
          
          if 'Results' in trivy:
              for result in trivy['Results']:
                  target = result.get('Target', 'Unknown')
                  print(f"\nðŸ“¦ Analyzing: {target}")
                  
                  for vuln in result.get('Vulnerabilities', []):
                      if vuln.get('Severity') in ['CRITICAL', 'HIGH']:
                          pkg_name = vuln.get('PkgName', 'Unknown')
                          current_ver = vuln.get('InstalledVersion', 'Unknown')
                          fixed_ver = vuln.get('FixedVersion', '')
                          cve = vuln.get('VulnerabilityID', 'N/A')
                          severity = vuln.get('Severity', 'Unknown')
                          
                          print(f"  ðŸ”´ [{severity}] {pkg_name}:{current_ver}")
                          print(f"     CVE: {cve}")
                          print(f"     Fix: {fixed_ver}")
                          
                          # Maven coordinates
                          if ':' in pkg_name:
                              parts = pkg_name.split(':')
                              if len(parts) >= 2:
                                  group_id = parts[0]
                                  artifact_id = parts[1]
                              else:
                                  group_id = pkg_name
                                  artifact_id = pkg_name
                          else:
                              # Try common Maven group IDs for known packages
                              artifact_id = pkg_name
                              if pkg_name.startswith('logback'):
                                  group_id = 'ch.qos.logback'
                              elif pkg_name.startswith('jackson'):
                                  group_id = 'com.fasterxml.jackson.core'
                              elif pkg_name.startswith('akka'):
                                  group_id = 'com.typesafe.akka'
                              else:
                                  group_id = pkg_name
                          
                          key = f"{group_id}:{artifact_id}"
                          if key not in vulnerabilities or fixed_ver:
                              vulnerabilities[key] = {
                                  'groupId': group_id,
                                  'artifactId': artifact_id,
                                  'currentVersion': current_ver,
                                  'fixedVersion': fixed_ver if fixed_ver else current_ver,
                                  'cve': cve,
                                  'severity': severity,
                                  'target': target
                              }
          
          # Save identified vulnerabilities
          with open('fixes/transitive-vulns.json', 'w') as f:
              json.dump(list(vulnerabilities.values()), f, indent=2)
          
          print("\n" + "=" * 80)
          print(f"âœ… Found {len(vulnerabilities)} unique vulnerable dependencies")
          print("=" * 80)
          
          # Set output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"vuln_count={len(vulnerabilities)}\n")
              f.write(f"has_vulns={'true' if len(vulnerabilities) > 0 else 'false'}\n")
          EOF
          
          python3 identify_transitive.py
      
      # ============================================
      # 3. Apply Fixes Using Dependency Management
      # ============================================
      - name: Apply Dependency Management Fixes
        if: steps.identify.outputs.has_vulns == 'true'
        run: |
          cat > apply_fixes.py << 'EOF'
          import json
          import xml.etree.ElementTree as ET
          import os
          
          # Load vulnerabilities
          with open('fixes/transitive-vulns.json') as f:
              vulns = json.load(f)
          
          print("=" * 80)
          print("APPLYING DEPENDENCY MANAGEMENT FIXES")
          print("=" * 80)
          
          # Process each pom.xml
          import glob
          pom_files = glob.glob('**/pom.xml', recursive=True)
          pom_files = [p for p in pom_files if 'target' not in p]
          
          for pom_path in pom_files:
              print(f"\nðŸ“ Processing: {pom_path}")
              
              try:
                  # Read pom.xml
                  with open(pom_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # Register namespaces to preserve them
                  ET.register_namespace('', 'http://maven.apache.org/POM/4.0.0')
                  ET.register_namespace('xsi', 'http://www.w3.org/2001/XMLSchema-instance')
                  
                  tree = ET.parse(pom_path)
                  root = tree.getroot()
                  
                  # Maven namespace
                  ns = {'maven': 'http://maven.apache.org/POM/4.0.0'}
                  
                  # Find or create dependencyManagement section
                  dep_mgmt = root.find('maven:dependencyManagement', ns)
                  if dep_mgmt is None:
                      # Create new dependencyManagement section
                      dep_mgmt = ET.SubElement(root, '{http://maven.apache.org/POM/4.0.0}dependencyManagement')
                      dependencies = ET.SubElement(dep_mgmt, '{http://maven.apache.org/POM/4.0.0}dependencies')
                      print("  âœ… Created new dependencyManagement section")
                  else:
                      dependencies = dep_mgmt.find('maven:dependencies', ns)
                      if dependencies is None:
                          dependencies = ET.SubElement(dep_mgmt, '{http://maven.apache.org/POM/4.0.0}dependencies')
                  
                  # Add/update dependencies
                  added_count = 0
                  for vuln in vulns:
                      group_id = vuln['groupId']
                      artifact_id = vuln['artifactId']
                      fixed_version = vuln['fixedVersion']
                      
                      if not fixed_version or fixed_version == 'Not available':
                          continue
                      
                      # Check if dependency already exists
                      existing = dependencies.findall('maven:dependency', ns)
                      found = False
                      
                      for dep in existing:
                          g = dep.find('maven:groupId', ns)
                          a = dep.find('maven:artifactId', ns)
                          if g is not None and a is not None:
                              if g.text == group_id and a.text == artifact_id:
                                  # Update version
                                  v = dep.find('maven:version', ns)
                                  if v is not None:
                                      v.text = fixed_version
                                  else:
                                      v = ET.SubElement(dep, '{http://maven.apache.org/POM/4.0.0}version')
                                      v.text = fixed_version
                                  found = True
                                  print(f"  âœ… Updated: {group_id}:{artifact_id} â†’ {fixed_version}")
                                  added_count += 1
                                  break
                      
                      if not found:
                          # Add new dependency
                          dep = ET.SubElement(dependencies, '{http://maven.apache.org/POM/4.0.0}dependency')
                          g = ET.SubElement(dep, '{http://maven.apache.org/POM/4.0.0}groupId')
                          g.text = group_id
                          a = ET.SubElement(dep, '{http://maven.apache.org/POM/4.0.0}artifactId')
                          a.text = artifact_id
                          v = ET.SubElement(dep, '{http://maven.apache.org/POM/4.0.0}version')
                          v.text = fixed_version
                          print(f"  âœ… Added: {group_id}:{artifact_id}:{fixed_version}")
                          added_count += 1
                  
                  if added_count > 0:
                      # Write back with proper formatting
                      tree.write(pom_path, encoding='utf-8', xml_declaration=True)
                      
                      # Fix formatting (ElementTree doesn't preserve nice formatting)
                      with open(pom_path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      # Add XML declaration if missing
                      if not content.startswith('<?xml'):
                          content = '<?xml version="1.0" encoding="UTF-8"?>\n' + content
                      
                      with open(pom_path, 'w', encoding='utf-8') as f:
                          f.write(content)
                      
                      print(f"  ðŸ’¾ Saved changes ({added_count} dependencies managed)")
                  
              except Exception as e:
                  print(f"  âš ï¸ Error processing {pom_path}: {e}")
          
          print("\n" + "=" * 80)
          print("âœ… Dependency management applied to all pom.xml files")
          print("=" * 80)
          EOF
          
          python3 apply_fixes.py
      
      - name: Apply SBT Dependency Overrides
        if: steps.identify.outputs.has_vulns == 'true'
        run: |
          cat > apply_sbt_fixes.py << 'EOF'
          import json
          import os
          
          # Load vulnerabilities
          with open('fixes/transitive-vulns.json') as f:
              vulns = json.load(f)
          
          # Check if root build.sbt exists
          if os.path.exists('build.sbt'):
              with open('build.sbt', 'r') as f:
                  content = f.read()
              
              # Check if dependencyOverrides already exists
              if 'dependencyOverrides' not in content:
                  # Add dependencyOverrides section
                  overrides = '\n// Security: Override vulnerable transitive dependencies\n'
                  overrides += 'ThisBuild / dependencyOverrides ++= Seq(\n'
                  
                  for vuln in vulns:
                      if vuln['fixedVersion'] and vuln['fixedVersion'] != 'Not available':
                          group_id = vuln['groupId']
                          artifact_id = vuln['artifactId']
                          version = vuln['fixedVersion']
                          overrides += f'  "{group_id}" % "{artifact_id}" % "{version}",  // {vuln["cve"]}\n'
                  
                  overrides += ')\n'
                  
                  with open('build.sbt', 'a') as f:
                      f.write(overrides)
                  
                  print("âœ… Added dependencyOverrides to build.sbt")
              else:
                  print("â„¹ï¸ dependencyOverrides already exists in build.sbt")
          else:
              print("â„¹ï¸ No root build.sbt file found")
          EOF
          
          python3 apply_sbt_fixes.py
      
      # ============================================
      # 4. Generate PR Content
      # ============================================
      - name: Generate PR Documentation
        if: steps.identify.outputs.has_vulns == 'true'
        run: |
          cat > generate_pr.py << 'EOF'
          import json
          
          with open('fixes/transitive-vulns.json') as f:
              vulns = json.load(f)
          
          pr_body = "# ðŸ”’ Fix Transitive Dependency Vulnerabilities\n\n"
          pr_body += "This PR fixes vulnerabilities in **transitive dependencies** (dependencies of dependencies).\n\n"
          pr_body += "## ðŸŽ¯ Problem\n\n"
          pr_body += "These vulnerabilities exist in dependencies that are brought in by your direct dependencies. "
          pr_body += "They don't appear directly in your pom.xml/build.sbt files, but Maven/SBT pulls them in automatically.\n\n"
          pr_body += "## âœ… Solution\n\n"
          pr_body += "This PR uses **dependency management** to force secure versions:\n\n"
          pr_body += "### For Maven (pom.xml):\n"
          pr_body += "Added/updated `<dependencyManagement>` section to force secure versions of transitive dependencies.\n\n"
          pr_body += "### For SBT (build.sbt):\n"
          pr_body += "Added `dependencyOverrides` to force secure versions.\n\n"
          pr_body += "## ðŸ”´ Vulnerabilities Fixed\n\n"
          pr_body += f"**Total:** {len(vulns)} vulnerable transitive dependencies\n\n"
          
          critical = [v for v in vulns if v['severity'] == 'CRITICAL']
          high = [v for v in vulns if v['severity'] == 'HIGH']
          
          if critical:
              pr_body += "### ðŸ”´ CRITICAL\n\n"
              for vuln in critical:
                  pr_body += f"**{vuln['groupId']}:{vuln['artifactId']}**\n"
                  pr_body += f"- Current: `{vuln['currentVersion']}`\n"
                  pr_body += f"- Fixed: `{vuln['fixedVersion']}`\n"
                  pr_body += f"- CVE: {vuln['cve']}\n\n"
          
          if high:
              pr_body += "### ðŸŸ  HIGH\n\n"
              for vuln in high:
                  pr_body += f"**{vuln['groupId']}:{vuln['artifactId']}**\n"
                  pr_body += f"- Current: `{vuln['currentVersion']}`\n"
                  pr_body += f"- Fixed: `{vuln['fixedVersion']}`\n"
                  pr_body += f"- CVE: {vuln['cve']}\n\n"
          
          pr_body += "## ðŸ§ª Testing\n\n"
          pr_body += "Please verify:\n"
          pr_body += "1. âœ… `mvn clean install` or `sbt compile` succeeds\n"
          pr_body += "2. âœ… All tests pass\n"
          pr_body += "3. âœ… Application runs correctly\n"
          pr_body += "4. âœ… Check that transitive dependencies are overridden:\n"
          pr_body += "   - Maven: `mvn dependency:tree`\n"
          pr_body += "   - SBT: `sbt dependencyTree`\n\n"
          pr_body += "## ðŸ“š How This Works\n\n"
          pr_body += "**Dependency Management** tells Maven/SBT:\n"
          pr_body += '> "When ANY dependency requests package X, use version Y instead of what they ask for."\n\n'
          pr_body += "This overrides vulnerable transitive dependency versions throughout your entire dependency tree.\n\n"
          pr_body += "## âš ï¸ Important\n\n"
          pr_body += "- These changes affect your **entire dependency tree**\n"
          pr_body += "- Test thoroughly to ensure no compatibility issues\n"
          pr_body += "- Consider updating direct dependencies to versions that don't pull in vulnerable transitives\n\n"
          pr_body += "---\n\n"
          pr_body += "*Generated by: Fix Transitive Dependencies workflow*\n"
          
          with open('fixes/pr-body.md', 'w') as f:
              f.write(pr_body)
          
          print("âœ… PR documentation generated")
          EOF
          
          python3 generate_pr.py
      
      # ============================================
      # 5. Check for Changes
      # ============================================
      - name: Check for changes
        id: check_changes
        if: steps.identify.outputs.has_vulns == 'true'
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes were made"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
            echo ""
            echo "Changed files:"
            git diff --name-only
          fi
      
      # ============================================
      # 6. Create Pull Request
      # ============================================
      - name: Create Pull Request
        id: create_pr
        if: steps.identify.outputs.has_vulns == 'true' && steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”’ Security: Fix ${{ steps.identify.outputs.vuln_count }} transitive dependency vulnerabilities
            
            Applied dependency management to force secure versions of transitive dependencies.
            This overrides vulnerable versions throughout the dependency tree.
          title: "ðŸ”’ Security: Fix ${{ steps.identify.outputs.vuln_count }} Transitive Dependency Vulnerabilities"
          body-path: fixes/pr-body.md
          branch: security/fix-transitive-dependencies
          delete-branch: true
          labels: |
            security
            dependencies
            transitive-dependencies
            automated-pr
          assignees: abhijeetardale-flui
          reviewers: abhijeetardale-flui
      
      - name: Display PR Information
        if: steps.create_pr.outputs.pull-request-number
        run: |
          echo "ðŸŽ‰ Pull Request Created Successfully!"
          echo ""
          echo "PR Number: ${{ steps.create_pr.outputs.pull-request-number }}"
          echo "PR URL: ${{ steps.create_pr.outputs.pull-request-url }}"
          echo ""
          echo "âœ… This PR fixes TRANSITIVE DEPENDENCY vulnerabilities"
          echo "âœ… Go review your PR at:"
          echo "${{ steps.create_pr.outputs.pull-request-url }}"
      
      # ============================================
      # 7. Workflow Summary
      # ============================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ”’ Transitive Dependency Vulnerability Fix" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.identify.outputs.has_vulns }}" == "true" ]; then
            echo "### ðŸ“Š Results:" >> $GITHUB_STEP_SUMMARY
            echo "- **Vulnerabilities Found:** ${{ steps.identify.outputs.vuln_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Type:** Transitive Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
              echo "### âœ… PR Created!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              if [ -n "${{ steps.create_pr.outputs.pull-request-url }}" ]; then
                echo "**ðŸŽ‰ Pull Request:** [#${{ steps.create_pr.outputs.pull-request-number }}](${{ steps.create_pr.outputs.pull-request-url }})" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              echo "**What was fixed:**" >> $GITHUB_STEP_SUMMARY
              echo "- Added `<dependencyManagement>` to Maven pom.xml files" >> $GITHUB_STEP_SUMMARY
              echo "- Added `dependencyOverrides` to SBT build.sbt (if applicable)" >> $GITHUB_STEP_SUMMARY
              echo "- Forces secure versions of transitive dependencies" >> $GITHUB_STEP_SUMMARY
            else
              echo "### â„¹ï¸ No Changes Made" >> $GITHUB_STEP_SUMMARY
              echo "Vulnerabilities found but no changes were applied." >> $GITHUB_STEP_SUMMARY
              echo "This could mean the fixes are already in place." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âœ… No Transitive Dependency Vulnerabilities Found!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š About Transitive Dependencies:" >> $GITHUB_STEP_SUMMARY
          echo "Transitive dependencies are dependencies of your dependencies." >> $GITHUB_STEP_SUMMARY
          echo "This workflow uses dependency management to override their versions." >> $GITHUB_STEP_SUMMARY

