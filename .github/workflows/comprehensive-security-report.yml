name: Comprehensive Security Report (Veracode-style)

# Generate detailed security reports similar to Veracode
# Includes: SAST, SCA, vulnerability details, CVSS scores, remediation guidance

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM UTC
  push:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  comprehensive-security-scan:
    name: Generate Comprehensive Security Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Create reports directory
        run: |
          mkdir -p security-reports
          mkdir -p security-reports/raw
          mkdir -p security-reports/html
      
      # ============================================
      # 1. OWASP Dependency Check (SCA)
      # ============================================
      - name: OWASP Dependency Check
        continue-on-error: true
        run: |
          echo "ðŸ” Running OWASP Dependency Check..."
          
          # Download OWASP Dependency Check
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip -q dependency-check-9.0.9-release.zip
          
          # Run dependency check
          ./dependency-check/bin/dependency-check.sh \
            --scan . \
            --format ALL \
            --out security-reports/owasp \
            --prettyPrint \
            --enableExperimental \
            --nvdApiKey ${{ secrets.NVD_API_KEY || 'NONE' }} \
            || true
          
          echo "âœ… OWASP Dependency Check complete"
      
      # ============================================
      # 2. Trivy Vulnerability Scanner
      # ============================================
      - name: Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'security-reports/raw/trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln,secret,config'
      
      - name: Trivy SARIF Report
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'security-reports/raw/trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
      
      - name: Trivy Table Report (for reference)
        continue-on-error: true
        run: |
          echo "ðŸ” Generating Trivy table report..."
          
          # Install trivy if not already available
          if ! command -v trivy &> /dev/null; then
            wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            sudo apt-get update
            sudo apt-get install trivy -y
          fi
          
          # Generate table report
          trivy fs . \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            --format table \
            --output security-reports/raw/trivy-table.txt \
            || true
          
          echo "âœ… Trivy table report generated"
      
      # ============================================
      # 3. Semgrep SAST
      # ============================================
      - name: Semgrep Security Scan
        continue-on-error: true
        run: |
          echo "ðŸ” Running Semgrep SAST..."
          
          docker run --rm -v "${PWD}:/src" returntocorp/semgrep:latest \
            semgrep scan --config auto \
            --json --output /src/security-reports/raw/semgrep-results.json \
            /src || true
          
          docker run --rm -v "${PWD}:/src" returntocorp/semgrep:latest \
            semgrep scan --config auto \
            --sarif --output /src/security-reports/raw/semgrep-results.sarif \
            /src || true
          
          echo "âœ… Semgrep scan complete"
      
      # ============================================
      # 4. SpotBugs (Java-specific)
      # ============================================
      - name: Build projects for SpotBugs
        continue-on-error: true
        run: |
          echo "ðŸ”¨ Building Java projects..."
          
          # Build Maven projects
          for pom in $(find . -name "pom.xml" -type f); do
            dir=$(dirname "$pom")
            echo "Building $dir..."
            cd "$dir"
            mvn clean compile -DskipTests || true
            cd - > /dev/null
          done
          
          echo "âœ… Build complete"
      
      - name: Run SpotBugs
        continue-on-error: true
        run: |
          echo "ðŸ” Running SpotBugs analysis..."
          
          # Download SpotBugs
          wget -q https://repo.maven.apache.org/maven2/com/github/spotbugs/spotbugs/4.8.3/spotbugs-4.8.3.zip
          unzip -q spotbugs-4.8.3.zip
          
          # Run SpotBugs on compiled classes
          for dir in $(find . -type d -name "classes" | grep target); do
            echo "Analyzing $dir..."
            ./spotbugs-4.8.3/bin/spotbugs \
              -textui -html \
              -output "security-reports/raw/spotbugs-$(basename $(dirname $(dirname $dir))).html" \
              "$dir" || true
          done
          
          echo "âœ… SpotBugs analysis complete"
      
      # ============================================
      # 5. Generate Comprehensive Report
      # ============================================
      - name: Generate Veracode-style Report
        continue-on-error: true
        run: |
          cat > security-reports/generate_report.py << 'PYTHON_SCRIPT'
          import json
          import os
          from datetime import datetime
          from collections import defaultdict
          
          # Load scan results
          def load_json_safe(filepath):
              try:
                  with open(filepath, 'r') as f:
                      return json.load(f)
              except:
                  return {}
          
          trivy_data = load_json_safe('security-reports/raw/trivy-results.json')
          semgrep_data = load_json_safe('security-reports/raw/semgrep-results.json')
          
          # Parse vulnerabilities
          vulnerabilities = []
          
          # Parse Trivy results
          if 'Results' in trivy_data:
              for result in trivy_data.get('Results', []):
                  for vuln in result.get('Vulnerabilities', []):
                      vulnerabilities.append({
                          'source': 'Trivy',
                          'type': 'SCA',
                          'severity': vuln.get('Severity', 'UNKNOWN'),
                          'cve': vuln.get('VulnerabilityID', 'N/A'),
                          'package': vuln.get('PkgName', 'Unknown'),
                          'version': vuln.get('InstalledVersion', 'Unknown'),
                          'fixed_version': vuln.get('FixedVersion', 'Not available'),
                          'title': vuln.get('Title', 'No title'),
                          'description': vuln.get('Description', 'No description'),
                          'cvss': vuln.get('CVSS', {}).get('nvd', {}).get('V3Score', 'N/A'),
                          'references': vuln.get('References', [])
                      })
          
          # Parse Semgrep results
          if 'results' in semgrep_data:
              for result in semgrep_data.get('results', []):
                  severity_map = {'ERROR': 'HIGH', 'WARNING': 'MEDIUM', 'INFO': 'LOW'}
                  vulnerabilities.append({
                      'source': 'Semgrep',
                      'type': 'SAST',
                      'severity': severity_map.get(result.get('extra', {}).get('severity', 'INFO'), 'LOW'),
                      'cve': result.get('check_id', 'N/A'),
                      'package': result.get('path', 'Unknown'),
                      'version': 'N/A',
                      'fixed_version': 'See remediation',
                      'title': result.get('extra', {}).get('message', 'Security issue detected'),
                      'description': result.get('extra', {}).get('metadata', {}).get('description', 'No description'),
                      'cvss': 'N/A',
                      'references': result.get('extra', {}).get('metadata', {}).get('references', [])
                  })
          
          # Count by severity
          severity_counts = defaultdict(int)
          for vuln in vulnerabilities:
              severity_counts[vuln['severity']] += 1
          
          # Generate HTML Report
          html_content = f'''
          <!DOCTYPE html>
          <html>
          <head>
              <title>Security Scan Report - {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}</title>
              <style>
                  body {{
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background: #f5f5f5;
                  }}
                  .header {{
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 30px;
                      border-radius: 10px;
                      margin-bottom: 30px;
                      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  }}
                  .header h1 {{
                      margin: 0;
                      font-size: 32px;
                  }}
                  .header .subtitle {{
                      margin-top: 10px;
                      opacity: 0.9;
                  }}
                  .summary {{
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }}
                  .summary-card {{
                      background: white;
                      padding: 20px;
                      border-radius: 10px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      text-align: center;
                  }}
                  .summary-card .number {{
                      font-size: 36px;
                      font-weight: bold;
                      margin-bottom: 10px;
                  }}
                  .summary-card .label {{
                      color: #666;
                      font-size: 14px;
                      text-transform: uppercase;
                  }}
                  .critical {{ color: #dc3545; }}
                  .high {{ color: #fd7e14; }}
                  .medium {{ color: #ffc107; }}
                  .low {{ color: #28a745; }}
                  .info {{ color: #17a2b8; }}
                  
                  .vulnerabilities {{
                      background: white;
                      padding: 20px;
                      border-radius: 10px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }}
                  .vuln-item {{
                      border-left: 4px solid;
                      padding: 15px;
                      margin-bottom: 15px;
                      background: #f8f9fa;
                      border-radius: 5px;
                  }}
                  .vuln-item.CRITICAL {{ border-left-color: #dc3545; }}
                  .vuln-item.HIGH {{ border-left-color: #fd7e14; }}
                  .vuln-item.MEDIUM {{ border-left-color: #ffc107; }}
                  .vuln-item.LOW {{ border-left-color: #28a745; }}
                  
                  .vuln-header {{
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 10px;
                  }}
                  .vuln-title {{
                      font-weight: bold;
                      font-size: 16px;
                  }}
                  .severity-badge {{
                      padding: 5px 10px;
                      border-radius: 15px;
                      font-size: 12px;
                      font-weight: bold;
                      color: white;
                  }}
                  .severity-badge.CRITICAL {{ background: #dc3545; }}
                  .severity-badge.HIGH {{ background: #fd7e14; }}
                  .severity-badge.MEDIUM {{ background: #ffc107; color: #333; }}
                  .severity-badge.LOW {{ background: #28a745; }}
                  
                  .vuln-details {{
                      font-size: 14px;
                      color: #666;
                      line-height: 1.6;
                  }}
                  .vuln-meta {{
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 10px;
                      margin-top: 10px;
                      padding-top: 10px;
                      border-top: 1px solid #ddd;
                  }}
                  .meta-item {{
                      font-size: 13px;
                  }}
                  .meta-label {{
                      font-weight: bold;
                      color: #333;
                  }}
                  .footer {{
                      text-align: center;
                      margin-top: 30px;
                      padding: 20px;
                      color: #666;
                      font-size: 14px;
                  }}
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ðŸ”’ Comprehensive Security Scan Report</h1>
                  <div class="subtitle">
                      <strong>Repository:</strong> akka-sample<br>
                      <strong>Scan Date:</strong> {datetime.now().strftime("%Y-%m-%d %H:%M:%S UTC")}<br>
                      <strong>Scan Type:</strong> SAST + SCA (Software Composition Analysis)
                  </div>
              </div>
              
              <div class="summary">
                  <div class="summary-card">
                      <div class="number">{len(vulnerabilities)}</div>
                      <div class="label">Total Vulnerabilities</div>
                  </div>
                  <div class="summary-card">
                      <div class="number critical">{severity_counts.get('CRITICAL', 0)}</div>
                      <div class="label">Critical</div>
                  </div>
                  <div class="summary-card">
                      <div class="number high">{severity_counts.get('HIGH', 0)}</div>
                      <div class="label">High</div>
                  </div>
                  <div class="summary-card">
                      <div class="number medium">{severity_counts.get('MEDIUM', 0)}</div>
                      <div class="label">Medium</div>
                  </div>
                  <div class="summary-card">
                      <div class="number low">{severity_counts.get('LOW', 0)}</div>
                      <div class="label">Low</div>
                  </div>
              </div>
              
              <div class="vulnerabilities">
                  <h2>ðŸ“‹ Vulnerability Details</h2>
          '''
          
          # Sort vulnerabilities by severity
          severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3, 'UNKNOWN': 4}
          vulnerabilities.sort(key=lambda x: severity_order.get(x['severity'], 5))
          
          for vuln in vulnerabilities:
              html_content += f'''
                  <div class="vuln-item {vuln['severity']}">
                      <div class="vuln-header">
                          <div class="vuln-title">{vuln['title'][:100]}</div>
                          <span class="severity-badge {vuln['severity']}">{vuln['severity']}</span>
                      </div>
                      <div class="vuln-details">
                          {vuln['description'][:300]}...
                      </div>
                      <div class="vuln-meta">
                          <div class="meta-item">
                              <span class="meta-label">CVE/ID:</span> {vuln['cve']}
                          </div>
                          <div class="meta-item">
                              <span class="meta-label">Package:</span> {vuln['package']}
                          </div>
                          <div class="meta-item">
                              <span class="meta-label">Version:</span> {vuln['version']}
                          </div>
                          <div class="meta-item">
                              <span class="meta-label">Fixed Version:</span> {vuln['fixed_version']}
                          </div>
                          <div class="meta-item">
                              <span class="meta-label">CVSS Score:</span> {vuln['cvss']}
                          </div>
                          <div class="meta-item">
                              <span class="meta-label">Source:</span> {vuln['source']} ({vuln['type']})
                          </div>
                      </div>
                  </div>
              '''
          
          html_content += '''
              </div>
              
              <div class="footer">
                  <p>Generated by Comprehensive Security Scan Workflow</p>
                  <p>Powered by: Trivy, Semgrep, OWASP Dependency Check, SpotBugs</p>
              </div>
          </body>
          </html>
          '''
          
          # Write HTML report
          with open('security-reports/html/comprehensive-report.html', 'w') as f:
              f.write(html_content)
          
          # Generate JSON summary
          summary = {
              'scan_date': datetime.now().isoformat(),
              'repository': 'akka-sample',
              'total_vulnerabilities': len(vulnerabilities),
              'severity_breakdown': dict(severity_counts),
              'vulnerabilities': vulnerabilities
          }
          
          with open('security-reports/comprehensive-report.json', 'w') as f:
              json.dump(summary, f, indent=2)
          
          print(f"âœ… Generated comprehensive report with {len(vulnerabilities)} vulnerabilities")
          print(f"   - CRITICAL: {severity_counts.get('CRITICAL', 0)}")
          print(f"   - HIGH: {severity_counts.get('HIGH', 0)}")
          print(f"   - MEDIUM: {severity_counts.get('MEDIUM', 0)}")
          print(f"   - LOW: {severity_counts.get('LOW', 0)}")
          PYTHON_SCRIPT
          
          python3 security-reports/generate_report.py
      
      # ============================================
      # 6. Upload Reports
      # ============================================
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: security-reports/raw/trivy-results.sarif
      
      - name: Upload All Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: security-reports/
          retention-days: 90
      
      # ============================================
      # 7. Generate Summary
      # ============================================
      - name: Generate Workflow Summary
        if: always()
        run: |
          echo "## ðŸ”’ Comprehensive Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Scan Coverage:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **SAST** (Static Application Security Testing) - Semgrep" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **SCA** (Software Composition Analysis) - Trivy, OWASP" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Code Quality** - SpotBugs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Secret Detection** - Trivy" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Config Scanning** - Trivy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f security-reports/comprehensive-report.json ]; then
            echo "### ðŸŽ¯ Results:" >> $GITHUB_STEP_SUMMARY
            python3 << 'EOF'
          import json
          with open('security-reports/comprehensive-report.json') as f:
              data = json.load(f)
          print(f"- **Total Vulnerabilities:** {data['total_vulnerabilities']}")
          for severity, count in data['severity_breakdown'].items():
              emoji = {'CRITICAL': 'ðŸ”´', 'HIGH': 'ðŸŸ ', 'MEDIUM': 'ðŸŸ¡', 'LOW': 'ðŸŸ¢'}.get(severity, 'âšª')
              print(f"- **{severity}:** {emoji} {count}")
          EOF
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Reports:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Actions** tab â†’ This workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Scroll to **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "3. Download **security-reports.zip**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ Available Reports:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **comprehensive-report.html** - Main Veracode-style report â­" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **owasp/dependency-check-report.html** - OWASP full report" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **comprehensive-report.json** - Machine-readable summary" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **raw/trivy-table.txt** - Trivy scan results" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **SARIF files** - GitHub Security tab integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Scan completed at $(date -u)*" >> $GITHUB_STEP_SUMMARY

