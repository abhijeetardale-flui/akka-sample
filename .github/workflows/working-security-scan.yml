name: Working Security Scan (Simplified)

# Simplified security scan that actually works
# Scans for vulnerabilities and creates actionable report

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  scan-vulnerabilities:
    name: Scan for Vulnerabilities
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'
      
      - name: Generate vulnerability report
        run: |
          echo "# Security Vulnerability Report" > vulnerability-report.md
          echo "" >> vulnerability-report.md
          echo "**Scan Date**: $(date)" >> vulnerability-report.md
          echo "**Repository**: ${{ github.repository }}" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
          
          # Check for known vulnerable packages in build files
          echo "## Direct Dependencies Check" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
          
          found_vulns=false
          
          # Check all build.sbt files
          for file in $(find . -name "build.sbt" -not -path "*/target/*"); do
            echo "### Scanning: $file" >> vulnerability-report.md
            
            # Check for old Logback
            if grep -E 'logback.*1\.2\.[0-9]"' "$file" | grep -v "1\.2\.1[1-9]" > /dev/null 2>&1; then
              echo "- âš ï¸ **OLD LOGBACK**: Upgrade to 1.2.11+ (CVE-2021-42550)" >> vulnerability-report.md
              found_vulns=true
            fi
            
            # Check for old Akka
            if grep -E 'akka.*2\.5\.' "$file" > /dev/null 2>&1; then
              echo "- âš ï¸ **OLD AKKA 2.5.x**: Upgrade to 2.6.20+ (Multiple CVEs)" >> vulnerability-report.md
              found_vulns=true
            fi
            
            # Check for old Jackson
            if grep -E 'jackson.*2\.1[0-2]\.' "$file" > /dev/null 2>&1; then
              echo "- âš ï¸ **OLD JACKSON**: Upgrade to 2.13.5+ (Multiple CVEs)" >> vulnerability-report.md
              found_vulns=true
            fi
            
            echo "" >> vulnerability-report.md
          done
          
          if [ "$found_vulns" = false ]; then
            echo "âœ… No obvious vulnerable versions found in build files" >> vulnerability-report.md
          fi
          
          echo "" >> vulnerability-report.md
          echo "## Recommendations" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
          echo "1. Check [Dependabot Alerts](https://github.com/${{ github.repository }}/security/dependabot)" >> vulnerability-report.md
          echo "2. Update vulnerable dependencies in build.sbt files" >> vulnerability-report.md
          echo "3. Run \`sbt dependencyTree\` to find transitive dependencies" >> vulnerability-report.md
          echo "" >> vulnerability-report.md
          
          # Show Trivy results if available
          if [ -f "trivy-results.json" ]; then
            echo "## Trivy Scan Results" >> vulnerability-report.md
            echo "" >> vulnerability-report.md
            echo "Full Trivy results available in artifacts" >> vulnerability-report.md
          fi
          
          cat vulnerability-report.md
      
      - name: Create issue with findings
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('vulnerability-report.md', 'utf8');
            
            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security-scan'
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Updated Security Scan\n\n${report}\n\n---\n*Updated: ${new Date().toISOString()}*`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Security Vulnerability Scan Results',
                body: report,
                labels: ['security', 'security-scan']
              });
            }
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            vulnerability-report.md
            trivy-results.json
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "vulnerability-report.md" ]; then
            cat vulnerability-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the vulnerability report above" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Dependabot alerts for specific packages" >> $GITHUB_STEP_SUMMARY
          echo "3. Update dependencies in build.sbt files" >> $GITHUB_STEP_SUMMARY
          echo "4. Download artifacts for detailed Trivy results" >> $GITHUB_STEP_SUMMARY

