name: Manual Dependency Check & PR Creator

# This workflow can be manually triggered to check for dependency updates
# and create PRs immediately (doesn't wait for scheduled runs)

on:
  workflow_dispatch:
    inputs:
      create-prs:
        description: 'Auto-create PRs for updates?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Cache SBT
        uses: actions/cache@v4
        with:
          path: |
            ~/.ivy2/cache
            ~/.sbt
            ~/.coursier
          key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-
      
      - name: Add SBT plugins for dependency checking
        run: |
          # Add sbt-updates plugin temporarily
          cat > project/sbt-updates.sbt << 'EOF'
          addSbtPlugin("com.timushev.sbt" % "sbt-updates" % "0.6.4")
          EOF
      
      - name: Check for dependency updates
        id: check-updates
        run: |
          echo "## üîç Dependency Update Report" > dependency-report.md
          echo "" >> dependency-report.md
          echo "Checking all projects for available updates..." >> dependency-report.md
          echo "" >> dependency-report.md
          
          has_updates=false
          
          for dir in akka-sample-*/; do
            if [ -f "$dir/build.sbt" ]; then
              echo "### $dir" >> dependency-report.md
              cd "$dir"
              
              # Check for updates
              sbt dependencyUpdates > ../update-check.txt 2>&1 || true
              
              # Parse output for updates
              if grep -q "can be updated" ../update-check.txt; then
                echo "‚úÖ Updates available" >> ../dependency-report.md
                grep "can be updated" ../update-check.txt >> ../dependency-report.md || true
                has_updates=true
              else
                echo "‚úÖ All dependencies up to date" >> ../dependency-report.md
              fi
              
              echo "" >> ../dependency-report.md
              cd ..
            fi
          done
          
          if [ "$has_updates" = true ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          
          cat dependency-report.md
      
      - name: Create Issue with update recommendations
        if: steps.check-updates.outputs.has_updates == 'true' && inputs.create-prs == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üì¶ Dependency Updates Available',
              body: `${report}\n\n---\n\n**Action Required**: Review and update dependencies manually or wait for Scala Steward.\n\nTo update manually:\n\`\`\`bash\ncd <project-directory>\nsbt dependencyUpdates\n# Review updates and modify build.sbt\n\`\`\`\n\n**Generated by**: Manual Dependency Check workflow\n**Triggered by**: @${context.actor}`,
              labels: ['dependencies', 'enhancement']
            });
      
      - name: Trigger Scala Steward (if available)
        if: steps.check-updates.outputs.has_updates == 'true' && inputs.create-prs == 'true'
        run: |
          echo "Updates detected! Scala Steward will create PRs on its next scheduled run."
          echo "Or you can manually trigger the Scala Steward workflow."
      
      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-report
          path: |
            dependency-report.md
            update-check.txt
      
      - name: Summary
        if: always()
        run: |
          echo "## üîç Dependency Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dependency-report.md" ]; then
            cat dependency-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-updates.outputs.has_updates }}" == "true" ]; then
            echo "- ‚úÖ Updates found! Check the Issue created for details" >> $GITHUB_STEP_SUMMARY
            echo "- ‚è∞ Scala Steward will create PRs on Monday" >> $GITHUB_STEP_SUMMARY
            echo "- üîß Or manually trigger Scala Steward workflow now" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

  trigger-scala-steward:
    name: Trigger Scala Steward
    needs: check-dependencies
    runs-on: ubuntu-latest
    if: inputs.create-prs == 'true'
    
    steps:
      - name: Trigger Scala Steward Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'scala-steward.yml',
                ref: 'main'
              });
              console.log('‚úÖ Scala Steward workflow triggered successfully');
            } catch (error) {
              console.log('‚ö†Ô∏è Could not trigger Scala Steward. It will run on its scheduled time.');
              console.log('You can also trigger it manually from the Actions tab.');
            }

