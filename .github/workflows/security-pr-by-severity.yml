name: Security Fix Pull Requests by Severity

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'  # Every Monday at 03:00 UTC

permissions:
  contents: write
  pull-requests: write
  security-events: read
  actions: read

jobs:
  run-scan:
    name: Run Security Scans (SAST + SCA)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create scan directory
        run: |
          mkdir -p security-scan-data

      - name: Trivy filesystem scan (all severities)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'security-scan-data/trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          scanners: 'vuln'

      - name: Semgrep SAST scan (auto rules)
        continue-on-error: true
        run: |
          echo "ðŸ” Running Semgrep auto rules..."
          docker run --rm -v "${PWD}:/src" returntocorp/semgrep:latest \
            semgrep scan --config auto \
            --json --output /src/security-scan-data/semgrep-results.json \
            /src || true
          echo "âœ… Semgrep completed"

      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-data
          path: security-scan-data/
          retention-days: 7

  create-pr-by-severity:
    name: Create security PR for ${{ matrix.severity }} issues
    needs: run-scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        severity: [CRITICAL, HIGH, MEDIUM]
    env:
      TARGET_SEVERITY: ${{ matrix.severity }}
      LOWER_SEVERITY: ${{ matrix.severity == 'CRITICAL' && 'critical' || matrix.severity == 'HIGH' && 'high' || 'medium' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          mkdir -p pr-fixes
          mkdir -p security-reports/auto

      - name: Download scan data
        uses: actions/download-artifact@v4
        with:
          name: security-scan-data
          path: security-scan-data

      - name: Parse scan results for severity
        id: parse
        run: |
          python3 scripts/security/parse_by_severity.py

      - name: Apply dependency fixes (SCA)
        if: steps.parse.outputs.fixable_count != '0'
        run: |
          python3 scripts/security/apply_fixes.py

      - name: Generate PR body
        id: pr_body
        run: |
          python3 scripts/security/generate_pr_body.py

      - name: Check for repository changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ No changes detected â€“ skipping PR creation"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Repository changes detected"
            git status --short

      - name: Create pull request
        id: create_pr
        if: steps.parse.outputs.has_issues == 'true' && steps.diff.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”’ Security fixes â€“ ${{ matrix.severity }} severity
          title: "ðŸ”’ Security: ${{ matrix.severity }} severity fixes"
          body-path: pr-fixes/pr-body.md
          branch: security/auto-fix-${{ env.LOWER_SEVERITY }}
          delete-branch: true
          labels: |
            security
            automated-pr
            ${{ env.LOWER_SEVERITY }}
          assignees: abhijeetardale-flui
          reviewers: abhijeetardale-flui

      - name: Publish job summary
        if: always()
        run: |
          echo "## Security Severity Summary â€“ ${{ matrix.severity }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Has issues: ${{ steps.parse.outputs.has_issues }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Total issues: ${{ steps.parse.outputs.issue_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- SCA issues: ${{ steps.parse.outputs.sca_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- SAST issues: ${{ steps.parse.outputs.sast_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Auto-fixable: ${{ steps.parse.outputs.fixable_count }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.parse.outputs.has_issues }}" == "true" ]; then
            echo "- Summary file: security-reports/auto/${{ env.LOWER_SEVERITY }}-security-summary.md" >> "$GITHUB_STEP_SUMMARY"
            if [ "${{ steps.diff.outputs.changes }}" == "true" ]; then
              if [ -n "${{ steps.create_pr.outputs.pull-request-url }}" ]; then
                echo "- Pull request: ${{ steps.create_pr.outputs.pull-request-url }}" >> "$GITHUB_STEP_SUMMARY"
              fi
            else
              echo "- No repository changes detected for this severity." >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "- No issues detected for this severity." >> "$GITHUB_STEP_SUMMARY"
          fi
