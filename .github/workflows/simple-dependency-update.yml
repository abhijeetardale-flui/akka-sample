name: Simple Dependency Update (Alternative to Scala Steward)

# This workflow updates dependencies using sbt-updates plugin
# Works as an alternative when Scala Steward has issues

on:
  workflow_dispatch:
    inputs:
      create-prs:
        description: 'Create PRs for updates?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    # Run every Monday at 09:00 UTC
    - cron: '0 9 * * 1'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-dependencies:
    name: Check and Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Cache SBT
        uses: actions/cache@v4
        with:
          path: |
            ~/.ivy2/cache
            ~/.sbt
            ~/.coursier
          key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-
      
      - name: Add sbt-updates plugin
        run: |
          echo 'addSbtPlugin("com.timushev.sbt" % "sbt-updates" % "0.6.4")' >> project/plugins.sbt
      
      - name: Check for dependency updates
        id: check
        run: |
          echo "# Dependency Update Report" > update-report.md
          echo "" >> update-report.md
          echo "**Date**: $(date)" >> update-report.md
          echo "" >> update-report.md
          
          # Get updates for each project
          for dir in akka-sample-*/; do
            if [ -f "$dir/build.sbt" ]; then
              echo "## $dir" >> update-report.md
              echo "" >> update-report.md
              
              cd "$dir"
              echo "Checking updates for $dir..."
              
              # Run dependencyUpdates and capture output
              sbt dependencyUpdates 2>&1 | tee ../updates.txt
              
              # Extract important updates
              if grep -q "can be updated" ../updates.txt; then
                echo "### Available Updates:" >> ../update-report.md
                grep "can be updated" ../updates.txt >> ../update-report.md || true
                echo "" >> ../update-report.md
              else
                echo "âœ… All dependencies up to date" >> ../update-report.md
                echo "" >> ../update-report.md
              fi
              
              cd ..
            fi
          done
          
          cat update-report.md
      
      - name: Create update PRs
        if: inputs.create-prs == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating PRs for critical security updates..."
          
          # Check for critical packages that need updates
          NEEDS_UPDATE=false
          
          # Check for old Logback (CVE-2021-42550)
          if grep -r "logback.*1\.2\.[0-9]\"" akka-sample-*/build.sbt 2>/dev/null | grep -v "1\.2\.1[1-9]"; then
            echo "Found old Logback version"
            NEEDS_UPDATE=true
            
            # Update Logback to 1.2.11
            for file in $(find akka-sample-* -name "build.sbt"); do
              sed -i 's/\("ch.qos.logback".*"logback-.*"\).*"1\.2\.[0-9]"/\1 % "1.2.11"/g' "$file"
            done
          fi
          
          # Check for old Akka versions
          if grep -r "akka.*2\.5\." akka-sample-*/build.sbt 2>/dev/null; then
            echo "Found old Akka 2.5.x version"
            NEEDS_UPDATE=true
            
            # Update to Akka 2.6.20
            for file in $(find akka-sample-* -name "build.sbt"); do
              sed -i 's/\("com.typesafe.akka".*\)2\.5\.[0-9][0-9]*/\12.6.20/g' "$file"
            done
          fi
          
          if [ "$NEEDS_UPDATE" = true ]; then
            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # Create branch
            BRANCH="security-updates-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
            
            # Commit changes
            git add -A
            git commit -m "security: Update vulnerable dependencies" \
              -m "" \
              -m "- Update Logback to 1.2.11 (fixes CVE-2021-42550)" \
              -m "- Update Akka to 2.6.20 (fixes multiple CVEs)" \
              -m "" \
              -m "Automated security update generated by dependency scan."
            
            # Push branch
            git push origin "$BRANCH"
            
            # Create PR using GitHub CLI
            gh pr create \
              --title "ðŸ”’ Security: Update vulnerable dependencies" \
              --body "$(cat update-report.md)" \
              --label "security,dependencies,automated" \
              --base main \
              --head "$BRANCH"
            
            echo "âœ… PR created successfully!"
          else
            echo "â„¹ï¸ No critical security updates needed"
          fi
      
      - name: Create issue with update report
        if: inputs.create-prs == 'false'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('update-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“¦ Dependency Updates Available',
              body: `${report}\n\n---\n\n**Next Steps:**\n- Review the updates listed above\n- Run this workflow again with "Create PRs" = true to auto-create update PRs\n- Or manually update dependencies in build.sbt files\n\n**Generated by**: Simple Dependency Update workflow`,
              labels: ['dependencies', 'enhancement']
            });
      
      - name: Upload update report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-update-report
          path: |
            update-report.md
            updates.txt
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¦ Dependency Update Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "update-report.md" ]; then
            cat update-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.create-prs }}" == "true" ]; then
            echo "- âœ… PRs created for critical security updates (if any)" >> $GITHUB_STEP_SUMMARY
            echo "- Check Pull Requests tab to review and merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ“‹ Report created - check Issues tab" >> $GITHUB_STEP_SUMMARY
            echo "- Run workflow again with 'Create PRs: true' to auto-create update PRs" >> $GITHUB_STEP_SUMMARY
          fi

