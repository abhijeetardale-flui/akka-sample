name: Auto-Fix Security Issues

on:
  # Run after security scans complete
  workflow_run:
    workflows: ["SAST Scan (ShiftLeft/AppThreat)", "Semgrep Security Scan"]
    types:
      - completed
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      fix-type:
        description: 'Type of fixes to apply'
        required: true
        default: 'dependencies'
        type: choice
        options:
          - dependencies
          - code-quality
          - all

permissions:
  contents: write
  pull-requests: write
  security-events: read
  actions: read

jobs:
  dependency-fixes:
    name: Auto-Fix Dependency Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Cache SBT
        uses: actions/cache@v4
        with:
          path: |
            ~/.ivy2/cache
            ~/.sbt
            ~/.coursier
          key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-
      
      - name: Detect vulnerable dependencies
        id: detect-vulns
        run: |
          echo "Detecting vulnerable dependencies..."
          
          # Create a report of dependencies that need updates
          cat > dependency-update-plan.md << 'EOF'
          # Dependency Update Plan
          
          ## ðŸ” Detected Issues
          
          This automated agent has detected dependencies that need updates.
          
          ### Recommendations:
          EOF
          
          # Check for known vulnerable versions (you can expand this list)
          echo "Scanning build files for known vulnerable dependencies..."
          
          # Example: Check for old Akka versions
          if grep -r "2.5." akka-sample-*/build.sbt 2>/dev/null; then
            echo "- âš ï¸ Old Akka 2.5.x detected - recommend updating to 2.6.x or 2.8.x" >> dependency-update-plan.md
            echo "has_vulns=true" >> $GITHUB_OUTPUT
          fi
          
          # Check for old Play versions
          if grep -r "play.*2.6" akka-sample-*/build.sbt 2>/dev/null; then
            echo "- âš ï¸ Old Play Framework detected - recommend updating" >> dependency-update-plan.md
            echo "has_vulns=true" >> $GITHUB_OUTPUT
          fi
          
          cat dependency-update-plan.md
      
      - name: Run automatic dependency updates
        run: |
          echo "ðŸ¤– Automatic Dependency Update Agent Running..."
          
          # This is a placeholder for actual update logic
          # In practice, you would use tools like:
          # - sbt-updates plugin
          # - scala-steward
          # - dependabot (configured separately)
          
          for dir in akka-sample-*/; do
            if [ -f "$dir/build.sbt" ]; then
              echo "Checking $dir for updates..."
              cd "$dir"
              
              # Check for available updates (requires sbt-updates plugin)
              # sbt dependencyUpdates || true
              
              cd ..
            fi
          done
          
          echo "âœ… Dependency check complete"
      
      - name: Create issue for manual review
        if: steps.detect-vulns.outputs.has_vulns == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('dependency-update-plan.md', 'utf8');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– Security Agent: Dependency Updates Recommended',
              body: `${plan}\n\n---\n\n**Automated by Security Fix Agent**\nTriggered by: ${context.eventName}\nWorkflow: ${context.workflow}\n\nPlease review and apply these updates.`,
              labels: ['security', 'dependencies', 'automated-agent']
            });
      
      - name: Summary
        run: |
          echo "## ðŸ¤– Auto-Fix Agent Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Scanned all projects for vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Generated update recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Created issue for manual review (if needed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Dependabot will create PRs for dependency updates automatically." >> $GITHUB_STEP_SUMMARY

  code-quality-fixes:
    name: Auto-Fix Code Quality Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Apply automatic code formatting
        run: |
          echo "ðŸ¤– Code Quality Fix Agent Running..."
          
          # Install scalafmt if not present
          echo "Applying code formatting..."
          
          for dir in akka-sample-*/; do
            if [ -f "$dir/build.sbt" ]; then
              echo "Formatting $dir..."
              cd "$dir"
              
              # Apply scalafmt (if configured)
              # sbt scalafmtAll || echo "scalafmt not configured for $dir"
              
              cd ..
            fi
          done
      
      - name: Check for changes
        id: check-changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Code formatting changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No formatting changes needed"
          fi
      
      - name: Create Pull Request with fixes
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸ¤– Auto-fix: Apply code quality improvements"
          title: "ðŸ¤– Automated Code Quality Fixes"
          body: |
            ## ðŸ¤– Automated Code Quality Fixes
            
            This PR was automatically generated by the Auto-Fix Security Agent.
            
            ### Changes Applied:
            - âœ… Code formatting
            - âœ… Style consistency
            
            ### Review Required:
            Please review these automated changes before merging.
            
            **Generated by**: Auto-Fix Security workflow
            **Triggered by**: ${{ github.actor }}
          branch: auto-fix/code-quality
          delete-branch: true
          labels: |
            automated-agent
            code-quality
            auto-fix
      
      - name: Summary
        run: |
          echo "## ðŸ¤– Code Quality Fix Agent Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Applied code formatting" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Checked for style issues" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-changes.outputs.changes }}" == "true" ]; then
            echo "- âœ… Created PR with fixes" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
          fi

