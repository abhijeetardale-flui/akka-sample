name: Immediate Security Scan - Third-Party Libraries

# Comprehensive security scan for third-party dependencies
# This workflow can be triggered manually anytime

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**/build.sbt'
      - '**/pom.xml'
      - 'project/**'

permissions:
  contents: read
  security-events: write
  issues: write
  actions: read

jobs:
  dependency-vulnerability-scan:
    name: Third-Party Library Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Cache SBT
        uses: actions/cache@v4
        with:
          path: |
            ~/.ivy2/cache
            ~/.sbt
            ~/.coursier
          key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/project/**') }}
          restore-keys: |
            ${{ runner.os }}-sbt-
      
      - name: Generate dependency list for all projects
        run: |
          echo "# Third-Party Library Security Scan Report" > dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "**Scan Date**: $(date)" >> dependency-vulnerabilities.md
          echo "**Repository**: ${{ github.repository }}" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "---" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          
          # Generate dependency tree for each project
          for dir in akka-sample-*/; do
            if [ -f "$dir/build.sbt" ]; then
              echo "## $dir" >> dependency-vulnerabilities.md
              echo "" >> dependency-vulnerabilities.md
              echo "Scanning dependencies..." >> dependency-vulnerabilities.md
              echo "" >> dependency-vulnerabilities.md
              
              cd "$dir"
              
              # Get dependency tree
              echo '```' >> ../dependency-vulnerabilities.md
              sbt "dependencyTree" 2>&1 | grep -E "(com\.|org\.|io\.|net\.)" | head -50 >> ../dependency-vulnerabilities.md || true
              echo '```' >> ../dependency-vulnerabilities.md
              echo "" >> ../dependency-vulnerabilities.md
              
              cd ..
            fi
          done
      
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        continue-on-error: true
        with:
          project: 'akka-sample'
          path: '.'
          format: 'ALL'
          args: >
            --enableExperimental
            --failOnCVSS 0
            --suppression suppression.xml
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Run Snyk security scan
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --detection-depth=4
      
      - name: Check known vulnerable Akka versions
        id: check-akka
        run: |
          echo "## Known Vulnerable Akka Versions Check" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          
          vulnerable_found=false
          
          # Check for Akka versions with known CVEs
          if grep -r "akka.*2\.5\." akka-sample-*/build.sbt 2>/dev/null; then
            echo "âš ï¸ **CRITICAL**: Akka 2.5.x detected - Multiple CVEs" >> dependency-vulnerabilities.md
            echo "- CVE-2022-42004: Denial of Service" >> dependency-vulnerabilities.md
            echo "- CVE-2021-42550: Security vulnerability" >> dependency-vulnerabilities.md
            echo "- **Recommendation**: Upgrade to Akka 2.6.20+ or 2.8.x" >> dependency-vulnerabilities.md
            echo "" >> dependency-vulnerabilities.md
            vulnerable_found=true
          fi
          
          if grep -r "akka.*2\.6\.[0-9]\"" akka-sample-*/build.sbt 2>/dev/null | grep -v "2\.6\.2[0-9]"; then
            echo "âš ï¸ **HIGH**: Akka 2.6.0-2.6.19 detected - Security issues" >> dependency-vulnerabilities.md
            echo "- **Recommendation**: Upgrade to Akka 2.6.20+" >> dependency-vulnerabilities.md
            echo "" >> dependency-vulnerabilities.md
            vulnerable_found=true
          fi
          
          # Check for old Jackson versions
          if grep -r "jackson.*2\.1[0-2]\." akka-sample-*/build.sbt 2>/dev/null; then
            echo "âš ï¸ **HIGH**: Old Jackson version detected" >> dependency-vulnerabilities.md
            echo "- Multiple CVEs in Jackson 2.10-2.12" >> dependency-vulnerabilities.md
            echo "- **Recommendation**: Upgrade to Jackson 2.13+" >> dependency-vulnerabilities.md
            echo "" >> dependency-vulnerabilities.md
            vulnerable_found=true
          fi
          
          if [ "$vulnerable_found" = false ]; then
            echo "âœ… No known vulnerable versions detected in build files" >> dependency-vulnerabilities.md
            echo "" >> dependency-vulnerabilities.md
          fi
          
          echo "has_vulns=$vulnerable_found" >> $GITHUB_OUTPUT
      
      - name: Check GitHub Dependabot alerts
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              // Try to get Dependabot alerts
              const alerts = await github.rest.dependabot.listAlertsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });
              
              let report = '\n## GitHub Dependabot Alerts\n\n';
              
              if (alerts.data.length === 0) {
                report += 'âœ… No open Dependabot alerts\n\n';
              } else {
                report += `âš ï¸ **${alerts.data.length} open security alerts**\n\n`;
                
                for (const alert of alerts.data.slice(0, 10)) {
                  report += `### ${alert.security_advisory.severity.toUpperCase()}: ${alert.security_advisory.summary}\n`;
                  report += `- **Package**: ${alert.security_vulnerability.package.name}\n`;
                  report += `- **Vulnerable**: ${alert.security_vulnerability.vulnerable_version_range}\n`;
                  report += `- **CVE**: ${alert.security_advisory.cve_id || 'N/A'}\n`;
                  report += `- **Fixed in**: ${alert.security_vulnerability.first_patched_version?.identifier || 'No fix available'}\n`;
                  report += `- [View Alert](${alert.html_url})\n\n`;
                }
                
                if (alerts.data.length > 10) {
                  report += `\n_...and ${alerts.data.length - 10} more alerts_\n\n`;
                }
              }
              
              fs.appendFileSync('dependency-vulnerabilities.md', report);
            } catch (error) {
              console.log('Could not fetch Dependabot alerts:', error.message);
              fs.appendFileSync('dependency-vulnerabilities.md', '\n## GitHub Dependabot Alerts\n\nâš ï¸ Could not fetch alerts. Check manually at: https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/security/dependabot\n\n');
            }
      
      - name: Generate summary with recommendations
        run: |
          echo "" >> dependency-vulnerabilities.md
          echo "---" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "## Recommendations" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "### Immediate Actions:" >> dependency-vulnerabilities.md
          echo "1. Review all HIGH and CRITICAL severity vulnerabilities" >> dependency-vulnerabilities.md
          echo "2. Update vulnerable dependencies using Scala Steward PRs" >> dependency-vulnerabilities.md
          echo "3. Check [GitHub Security Advisories](https://github.com/${{ github.repository }}/security/dependabot)" >> dependency-vulnerabilities.md
          echo "4. Enable Dependabot security updates if not already enabled" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "### Prevention:" >> dependency-vulnerabilities.md
          echo "- âœ… Scala Steward will create PRs for dependency updates" >> dependency-vulnerabilities.md
          echo "- âœ… Dependabot monitors for new vulnerabilities" >> dependency-vulnerabilities.md
          echo "- âœ… Security scans run on every push" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "---" >> dependency-vulnerabilities.md
          echo "" >> dependency-vulnerabilities.md
          echo "**Generated by**: Immediate Security Scan workflow" >> dependency-vulnerabilities.md
          echo "**Triggered by**: @${{ github.actor }}" >> dependency-vulnerabilities.md
      
      - name: Create security issue with findings
        uses: actions/github-script@v7
        continue-on-error: true
        if: steps.check-akka.outputs.has_vulns == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('dependency-vulnerabilities.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Third-Party Library Security Vulnerabilities Detected',
              body: report,
              labels: ['security', 'dependencies', 'vulnerability', 'high-priority']
            });
      
      - name: Upload OWASP Dependency Check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: reports/
      
      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-scan-report
          path: |
            dependency-vulnerabilities.md
            trivy-results.sarif
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” Third-Party Library Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dependency-vulnerabilities.md" ]; then
            cat dependency-vulnerabilities.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Reports:" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability Scan Report (artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency Check Report (artifact)" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy SARIF Report (artifact)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Additional Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Dependabot Alerts](https://github.com/${{ github.repository }}/security/dependabot)" >> $GITHUB_STEP_SUMMARY
          echo "- [Security Tab](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY

